<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>FOSDEM::Perl Testing for Testing</title>
    
    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/extra.css">
    <link rel="stylesheet" href="css/theme/white.css">
    
    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="lib/css/zenburn.css">
    
    <!-- Printing and PDF exports -->
    <script>
     var link = document.createElement( 'link' );
     link.rel = 'stylesheet';
     link.type = 'text/css';
     link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
     document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>
  </head>

  <body>
    <div class="reveal">
      <div class="slides">
	<section><img src='img/paula-iv-ci.jpg' style='height:600px' alt='Clase de IV por Paula'>
	  <h3>Drawing by <a href='http://dev.to/terceranexus6'>Paula "TerceraNexus6"</a></h3>
	</section>
	
	<section><h1>Testing for testing</h1>
	  <h2>Using continuous integration in the classroom</h2>
	  <h3><code>@jjmerelo</code>, Granada Perl Mongers</h3>
	  <aside class='notes'>Why you should be interested in this?
	  Teaching is not one of
	  the <a href='http://www.cracked.com/blog/5-jobs-everyone-in-world-should-have-at-some-point/'>5
	      jobs everyone should have at some point.</a>, but it is
	  in <a href='https://www.theodysseyonline.com/10-jobs-everyone-should-have-to-do'>in
	      this other list, teacher.</a>. Everyone has to teach,
	  and you could as well do it the best way you can, using
	  perl. If what you teach is programming you should probably
	  evaluate it the same way that real pieces of programming
	  are evaluated.  </aside>
	</section>

	<!-- A bit of context -->
	<section>
	  <section data-background='https://farm1.staticflickr.com/555/31684311563_74426eccc2_k_d.jpg' alt='class of 2016-17, master'>
	    <h1>Cloud computing class</h1>
	    <h2>Undergraduate and master CS level</h2>
	    <aside class='notes'>This is last year's class. I have
	    less than a dozen students in master's and around 30 in
	    undergrad level. Cloud computing is about DevOps, and
	    about describing with software a system
	    architecture. Final objective is to deploy a web service
	    in one of several cloud providers. </aside>
	  </section>

	  <section data-background='https://farm6.staticflickr.com/5136/5489474407_596a9224f2_o_d.jpg'>
	    <h1>Flipped learning</h1>
	    <aside class='notes'>This emphasizes doing over listening,
	    and there's a more direct interaction with the student. It
	    also encourages students to learn at their own pace, doing
	      stuff when they see fit, fully asynchronously. </aside>
	  </section>

	  <section data-background='https://farm3.staticflickr.com/2111/2258467154_caa7f0dd4f_o_d.jpg'
	    alt='Astronautas que no son de verdad'>
	    <h1>Get real!</h1>
	    <h2 class='fragment'>Class as a metaphor for
	      real life<sup>TM</sup></h2>
	    <aside class='notes'>Use the same tools in class you would
	    use for the matter of the class: git for deployment, pull
	      requests, issues and milestones... Also, they didn't
	    have to fill boilerplate assignments, but decide on their
	    own project and pursue it in different milestones. The
	    project can be written in any language, but in fact
	    people chose Python, a few of them Ruby, Node.js and Go. </aside>
	  </section>

	  <section data-background='img/github.png'>
	    <h1>GitHub is my LMS</h1>
	    <aside class='notes'>GitHub is excellent as a learning
	    management system. Besides, it encourages students to use
	    and develop free software, and to be original. Its search
	      engine is also great for detecting
	    plagiarism. Assignments are turned in by adding your
	    project to a list. You can do a resubmission by changing
	    the version number of the list; there's also the
	    possibility of peer-reviewing, as it can be seen here.  And you
	    get an email every time some PR is made, so you don't have
	    to check often Moodle to see if there's something new
	    in. You can use issues for helping students, and
	    milestones for assignments, and so no. It's quite nice.</aside>

	  </section>
	</section>

	<!-- A new beginning -->
	<section>
	  <section data-background='https://farm2.staticflickr.com/1560/25883822136_f25e9b9347_o_d.jpg'
		   alt='dawn over Lawyer's creek'>
	    <h1>2017: a new beginning</h1>
	    <aside class='notes'>Fired from my appointment as director
	    of the free software office, all of a sudden I had a lot
	      of time in my hands... For the same reason, I lost the teaching assistant that checked
	    assignments before grading them. So it was a match made in
	      heaven, and I just had the tool for doing that.</aside>
	  </section>

	  <section data-background='https://farm5.staticflickr.com/4057/4272142306_98f0ff1a33_o_d.jpg'
	    alt='Hudson siren'>
	    <h1>Continuous integration to the rescue</h1>
	    <aside class='notes'>In fact, CI is part of the class and
	    they have to set it up for their projects from early
	    on. But in this case, the idea was to run tests on the
	      pull requests they made.</aside>
	  </section>

	  <section data-background='img/pull-request.png'>
	    <h1>Milestone release ~~ code review</h1>

	    <aside class='notes'>Thus we delved even deeper into the
	    metaphor: they had to deploy a milestone, and the
	    professor was the master that did the code review, looking
	      at the test problems. I did that before, although in
	    general I just checked that there was no conflict. I
	    didn't get into the submission itself until the tima of
	    grading. </aside>
	  </section>
	  
	  <section
	  data-background='https://farm1.staticflickr.com/619/20996949839_9be1423b2c_k_d.jpg'
alt='cute plush camel'><h1>Perl</h1>
	    <h1 class='fragment'>is my T. A. check</h1>
	    <aside class='notes'>This was not a difficult choice at
	  all. I had been using perl with git for some time, and of
	  course regexen and other things are a breeze. So I didn't
	      even think about using other languages. Besides, it's
	  helping me the way the teaching assistant did before, by
	  checking things. So Perl is my TAcheck :-)</aside>
	  </section>

	  <section><h1>It flies... or not</h1>
	    <img src='img/ci.png' alt='CI fails'>
	  </section>
	</section>

	<section> <!-- Checks and balances -->
	  <section><h1>What do we check?</h1>
	  </section>
	  <section><h1>Assignment == 1 line</h1>
	    <h2 class='fragment'>Repo URL is correct</h2>
	  </section>

	  
	  <section><h2>Δ Get the new submission from the diff</h2>
	    <pre><code>my $repo = Git->repository ( Directory => '.' );
my $diff = $repo->command('diff','HEAD^1','HEAD');
my $diff_regex = qr/a\/proyectos\/hito-(\d)\.md/;
my $github;
my ($this_hito) = ($diff =~ $diff_regex);
skip "No hay envío de proyecto", 5 unless defined $this_hito;
my @files = split(/diff --git/,$diff);
my ($diff_hito) = grep( /$diff_regex/, @files);
	    </code></pre></section>

	  
	  <section><h2>Is it a single line? ⃒</h2>

	    <pre><code>my @lines = split("\n",$diff_hito);
my @adds = grep(/^\+[^+]/,@lines);
is( $#adds, 0, "Añade sólo una línea");
my $url_repo;
if ( $adds[0] =~ /\(http/ ) {
  ($url_repo) = ($adds[0] =~ /\((http\S+)\)/);
} else {
  ($url_repo) = ($adds[0] =~ /^\+.+(http\S+)/s);
}
say $url_repo;
isnt($url_repo,"","El envío incluye un URL");
like($url_repo,qr/github.com/,"El URL es de GitHub");
</code></pre>
	  </section>

	  <section><h1>Download student's repo</h1>
	    <pre><code>my ($user,$name) = ($url_repo=~ /github.com\/(\S+)\/(.+)/);
my $repo_dir = "/tmp/$user-$name";
if (!(-e $repo_dir) or  !(-d $repo_dir) ) {
  mkdir($repo_dir);
  `git clone $url_repo $repo_dir`;
}
my $student_repo =  Git->repository ( Directory => $repo_dir );
my @repo_files = $student_repo->command("ls-files");</code></pre>

	    <aside class='notes'>Maybe I could use Git for that,
	      instead of the external command. Works well, anyway.</aside>
	  </section>
	  
	  <section>
	    <h1><code>Git</code> + <code>Test::More</code></h1>
	  </section>

	  <section><h1>A simple Travis configuration</h1>
	    <pre><code>branches:
  except:
    - gh-pages
language: perl
perl:
  - "5.16"
before_install:
install: cpanm Test::More Test::Harness Git File::Slurper JSON Net::Ping TAP::Formatter::Color Term::ANSIColor
script: prove -c
	    </code></pre>
	    <aside class='notes'>The test is in the same repo as the
	    file they do a PR on, so it's downloaded at the same
	      time. Assignments are on a different repository. </aside>
	  </section>
	  
	  <section data-background='img/travis-history.png'>
	    <h1>Checking...</h1>
	  </section>

	  <section><h1>Also checking</h1>
	    <h2 class='fragment'>Presence of files and directories in repo</h2>
	    <h2 class='fragment'>Extracting URLs and DNS names via
	      regexen</h2>
	  </section>

	  <section data-background='img/fails.png'>
	    <h1>Test fails ⚱ → Try again</h1>
	  </section>

	  <section><h1>Scraping for fun and profit</h1>
	    <h2 class='fragment'>Instant API ☻</h2>
	    <h2 class='fragment'>Checking milestones, issues and
	      commits</h2>
	    <aside class='notes'>The first version used GitHub's API,
	    but eventually it dawned on me that you can't use
	    environment variables in pull requests so I had to make do
	      with scraping. </aside>
	  </section>

	  <section>
	    <h1>Getting milestones info ⛼ </h1>
	    <pre><code>my $page = get( "https://github.com/$user/$repo/milestones" );
my ($milestones ) = ( $page =~ /(\d+)\s+Open/);</code></pre>

	    <pre class='fragment'><code>my $page = get( "https://github.com/$user/$repo".'/issues?q=is%3Aissue+is%3Aclosed' );
my (@closed_issues ) = ( $page =~ m{&lt;li\s+(id=.+?&lt;/li>)}gs ); </code></pre>

	    <pre class='fragment'><code>my $page = get( "https://github.com/$user/$repo/issues/$issue" );
return $page =~ /closed\s+this\s+in/gs ;</code></pre>

	  </section>

	  <section data-background='img/ok.png'><h1>Checks IPs, REST APIs, URLs...</h1>
	  </section>

	  <section><h1>Reaching out 𝌓</h1>
	    <pre><code>my $status = get "http://$deployment_url/status";
isnt( $status, undef, "Despliegue correcto en $deployment_url/status" );
my $status_ref = from_json( $status );
like ( $status_ref->{'status'}, qr/[Oo][Kk]/, "Status de $deployment_url correcto");</code></pre>

	    <pre class='fragment'><code>  my $pinger = Net::Ping->new();
  $pinger->port_number(22); # Puerto ssh
  isnt($pinger->ping($ip), 0, "$ip es alcanzable");</code></pre>

	  </section>

	</section>

	<section>
	  <section
	  data-background='https://farm5.staticflickr.com/4731/38398137574_a9cc8a997b_k_d.jpg'><h1>Saves
	    me a lot of time.</h1></section>

	  <section><h2>✓ Is it good for the students?</h2>
	    <img src='img/users-milestone.png' style='height:600px'
		 alt='Different users per milestone'>
	    <aside class='notes'>Do they learn more? Better? Faster?
	      Do they bug you less with questions? One of the
	    indicators would be how many drop out during the
	    term. Some times you can't just avoid it: They start a
	    side job, they have many other assignments, so there's a
	    "natural rhythm of decay". However, it was pretty bad last
	    year. As a side effect, I can produce these charts quite
	    easily, with Perl and doing a bit of repository mining, as
	    well as R for representation. In fact, I use Google Drive
	    for grading, so if I could combine this with a GData
	    client I would go full circle. I still might. Data-driven teaching!</aside>
	  </section>

	  <section><h2>Use <code>Git::Repo::Commits</code></h2>
	    <pre><code>  for my $h ( @{$repos{$r}[1]} ) {
    my ($milestone) = ($h =~ /(\d+)/);
    my @files = ("$preffix/$h.md");
    my $commits_obj = new Git::Repo::Commits "$home/$r", \@files;
    my @committers = map( $_->{'author'}, @{$commits_obj->commits});
    for my $d ( @committers ) {
      my ($email) = ($d =~ /<([^>]+)>/);
      $user_stats{"$email, $class, $milestone"}++;
    }
  }
	    </code></pre>
	    <aside class='notes'>I created this CPAN module, which is
	    right now into version 0.1.0, for I don't know what
	      purpose, but serves me fine for extracting data from the
	      repos. In this case it extracts from the repo only the
	    commits that refer to a particular file, the one used for
	    doing the pull requests, and gets the author information
	    from it. Similar scripts are used for getting dates and
	      other info.
	    </aside>
	  </section>

	  <section><h2>Testing until it sticks</h2>
	    <img src='img/users-milestone-boxplot.png'  style='height:600px'
		 alt='user-milestones boxplot'>
	    <aside class='notes'>Previously, it was mainly due to
	    conflicts. This year conflicts were almost 0 (there were
	    some, though), but the average number of changes was 0.4
	    times higher, going from 2.484 through  2.747 last year to
	    2.959 with the 3rd quartil going up from 3 to 4. Max
	      number went down, however.</aside>
	  </section>

	  <section><h3>Release early, release often</h3>
	    <img src='img/hito5.png' style='height:600px'
		 alt='Check-in time'>
	    <aside class='notes'>So people were not waiting until the
	    last possible minute to turn assignments in. They were
	    doing it much more extended in time, and even more so in
	    this last assignments. As soon as something was
	    half-baked, they tried their luck and sometimes it worked;
	    if it didn't, they had time to send it again. I
	    discouraged late submissions, but only via some penalty in
	    the grade, so it wasn't as if they were going to just fail
	    the subject. Anyway, people were encouraged to work a
	      little bit more regularly in the subject and test stuff. </aside>
	  </section>

	  <section><h1>What did students think?</h1>
	    <img src='img/poll.png' alt='poll results'>
	    <aside class='notes'>It helps them turn in the milestone
	    with less errors, and helps them to have inmediate
	    feedback on the result. You really have to intentionally
	    try to cheat if the test passes and then you fail when
	    graded. Or be totally clueless, which might
	    happen. There's been a bit of plagiarism, but that's been
	      the biggest problem. There are also 4 students who said
	    that the error messages weren't too helpful. I had to
	    tweak them during the term, to make them informative and
	    show exactly where the error was. </aside>
	  </section>
	</section>

	<section>
	  <section
	    data-background='https://farm6.staticflickr.com/5230/5863275896_e189aeb684_o_d.jpg'>
	    <h1>Semester is over</h1>
	  </section>

	  <section><h1>My assignments</h1>
	    <h2 class='fragment'>✓ Turn script into a <a href='https://github.com/JJ/p5-my-repo-test'>CPAN module</a></h2>
	    <h2 class='fragment'>✓ Extend tests: spell check, commits,
	      full REST APIs...</h2>
	    <h3 class='fragment'>✓ Check for plagiarism?</h3>

	    <aside class='notes'>I could also give automatic grading a
	  try... After all, you don't need an AI to grade every single
	      assignment. Or maybe you do, but that's
	  alright. Plagiarism could be done simply by using diffs,
	  however that can be defeated relatively simply and most of
	  the students use the same tools anyway; you can only create
	  a Dockerfile for Flask in so many different ways. So will have to do
	  some thinking about it. I started work on the CPAN module,
	  but then life got in the way... And the script already
	  worked flawlessly, so why bother. It's very raw for the time
	  being, and not ready for anything resembling release. Will
	  try to work on it this new, classless, term. </aside>
	  </section>

	  <section
	    data-background='https://farm5.staticflickr.com/4670/39930341021_7b3f27eb17_k_d.jpg'
	    ><h3>Lessons learned</h3>
	    <h2 class='fragment'>∴ Innovate to improve learning
	      experience</h2>
	    <h2 class='fragment'>∴ ... and check if it does</h2>
	    <h2 classs='fragment'>∴ A little scripting goes a long
	      way</h2>

	    <aside class='notes'>Painting by <a
	      href='http://www.museopicassomalaga.org/exposiciones-temporales/mujeres-artistas-y-surrealismo'>Dorothea
	      Tanning</a>, taken in the Picasso Museum last
	      Saturday. There's a lesson learned there about fighting
	      with giant sunflowers that invade your home or
	      something.</aside>
	    
	  </section>

	  <section
	    data-background='https://farm6.staticflickr.com/5463/31243345612_a068c4dd6b_k_d.jpg'>
	    <h1>Perl, helping me teach since 1994</h1>
	    <aside class='notes'>One of the first thing I did was to
	    develop a random test generator. Since then, I've used it
	    to create an assignment submission system, example in
	    several different classes and everywhere I've needed a
	    little scripting. This is probably my best effort so far,
	      and it might be kind of unique this way.</aside>
	  </section>
	</section>
	  
	<!-- credits -->
	<section>
	    <h2>Credits</h2>
	    <ul class='credits'>
	      <li>CI drawing
		by <a href='http://twitter.com/terceranexus6'>Paula</a></li>
	      <li>Hudson siren
		by <a href='https://www.flickr.com/photos/jankrutisch/4272142306/'>Jan
		  Krutisch</a>
	      </li>
	      <li>Hats in the air by <a
		href='https://www.flickr.com/photos/universityleicester/5863275896/'>University Leicester</a></li>
	  </ul>
	</section>

	
	<!-- End -->
	
      </div>
    </div>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.js"></script>
    
    <script>
      // More info about config & dependencies:
      // - https://github.com/hakimel/reveal.js#configuration
      // - https://github.com/hakimel/reveal.js#dependencies
      Reveal.initialize({
      history: true,
      width: '90%',
      
      dependencies: [
      { src: 'plugin/markdown/marked.js' },
      { src: 'plugin/markdown/markdown.js' },
      { src: 'plugin/notes/notes.js', async: true },
      { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
      ]
      });
    </script>
  </body>
</html>
